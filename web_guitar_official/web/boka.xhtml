<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <title>Boka tid</title>
        <meta name="description" content="" />
        <meta name="keywords" content="" />
        
        <script src="resources/js/jquery-3.2.1.min.js"></script>
        <script src="resources/js/skel.min.js"></script>
        <script src="resources/js/skel-layers.min.js"></script>
        <script src="resources/js/init.js"></script>


        <link rel="stylesheet" href="resources/css/style.css" />
        <link rel='stylesheet' href='resources/fullcalendar/fullcalendar.css' />
        <script src='resources/js/moment.min.js'></script>
        <script src='resources/fullcalendar/fullcalendar.js'></script>
        <script src='resources/fullcalendar/locale/sv.js'></script>
        <link rel='stylesheet' href='resources/jquery-ui/jquery-ui.css' />
        <script src="resources/jquery-ui/jquery-ui.js"></script>
    </h:head>
    <h:body id="top">
        <!-- Header -->
        <header id="header" class="skel-layers-fixed">
            <h1><a href="#">ANDERS GITARRVERKSTAD</a></h1>
            <nav id="nav">
                <ul>
                    <li><a href="index.html">START</a></li>
                    <li><a href="shop.html">SHOP</a></li>
                    <li><a href="boka.html">BOKA TID</a></li>
                    <li><a href="kontakt.html">KONTAKT</a></li>
                </ul>
            </nav>
        </header>
        <!-- Main -->
        <div>
            <div id="boka1" style ="margin-bottom:25px">
                <div style="margin: 10px" id="calendar"></div>
            </div>
        </div>
        <!-- Footer -->
        <footer id="footer">
            <div class="container">
                <div class="row double">
                </div>
            </div>
        </footer>
        <div id="dialog" title="Bekräfta bokning" style="display:none">
            <h:form id="dialog-form">
                <label>Förnamn: </label>
                <h:inputText id="test" value="#{userInputBean.firstName}"></h:inputText><br/>
                <label>Efternamn: </label>
                <h:inputText value="#{userInputBean.lastName}"></h:inputText><br/>
                <label>Email: </label>
                <h:inputText value="#{userInputBean.email}"></h:inputText><br/>
                <label>Tel: </label>
                <h:inputText value="#{userInputBean.phoneNumber}"></h:inputText><br/>
                <label>Beskrivning: </label>
                <h:inputTextarea value="#{userInputBean.info}"></h:inputTextarea><br/>
                <label>Bilder: </label>

                
                <h:inputHidden id="hidden-date" value="#{userInputBean.date}"></h:inputHidden>
                <h:inputHidden id="hidden-start" value="#{userInputBean.startTime}"></h:inputHidden>
                <h:inputHidden id="hidden-end" value="#{userInputBean.endTime}" ></h:inputHidden>
                
                <h:commandButton id="reserve-button" value="Boka" action="#{userInputBean.submit()}"></h:commandButton>
            </h:form>
        </div>
        
        <div id="error" title="Error" style="display: none">
            <p>Kan inte boka då detta tillfälle redan har inträffat</p>
        </div>
        
        <script>
            var addAllEvents = [];
        </script>
        
        <script>
            //<![CDATA[
        var events = [];
        var currentEvent;

        function insertEvent(name, date, startTime, endTime)
        {
            date = date.slice(0, date.indexOf("C")) + date.slice(date.length - 4, date.length);
            startTime = startTime.slice(0, startTime.indexOf("C")) + startTime.slice(startTime.length - 4, startTime.length);
            endTime = endTime.slice(0, endTime.indexOf("C")) + endTime.slice(endTime.length - 4, endTime.length);

            var dateTime = moment(date);
            var startDateTime = moment(startTime);
            var endDateTime = moment(endTime);

            var startValue = moment(dateTime.format("MM/DD/YYYY") + " " + startDateTime.format("HH:mm"),
                                    "MM/DD/YYYY HH:mm");
            var endValue = moment(dateTime.format("MM/DD/YYYY") + " " + endDateTime.format("HH:mm"),
                                    "MM/DD/YYYY HH:mm");

            var newid = 0;
            if(events.length > 0)
            {
                newid = events[events.length-1].id + 1;
            }
            var event = {
                id: newid,
                title: name,
                start: startValue,
                end: endValue,
                allDay: false,
                editable: false,
                color: 'red'};
            events.push(event);
        }
        
        $(document).ready(function() {
            // page is now ready, initialize the calendar...
            function displayEvents()
            {
                for(var i = 0; i < events.length; i++)
                {
                    $('#calendar').fullCalendar('renderEvent', events[i]);
                }
            }

            $('#reserve-button').click(function() {
                currentEvent.color = 'red';
                events.push(currentEvent);
                $('#calendar').fullCalendar('refetchEvents');
                displayEvents();
                $('#dialog').dialog("close");
                currentEvent = (function () { return; });
            });

            $('#calendar').fullCalendar({
                    // put your options and callbacks here
                eventClick: function(calEvent, jsEvent, view) {
                    if(currentEvent == undefined)
                    {
                        return;
                    }
                    if(calEvent.id == currentEvent.id)
                    {
                        $(function() {
                            $("#dialog").dialog({
                                width: "auto",
                                resizable: false,
                                modal: false
                            });
                        });
                        // change the border color just for fun
                        $(this).css('border-color', 'red');
                    }
                },
                dayNamesShort: ['', 'Måndag', 'Tisdag', 'Onsdag', 'Torsdag','Fredag'],
                dayOfMonthFormat:'ddd DD',
                defaultView: 'agendaWeek',
                weekNumbers: true,
                allDaySlot: false,
                minTime: "10:00:00",
                maxTime: "18:00:00",
                snapDuration: "00:30:00",
                height: "auto",
                selectable: true,
                weekends: false,
                selectOverlap: false,
                viewRender: function() {
                    displayEvents();
                },
                select: function(start, end) {
                    if(!Number.isInteger(start.time().asHours()))
                    {
                        start.minute(0);
                    }
                    var currentDate = moment();
                    if(start.week() < currentDate.week())
                    {
                        $("#error").dialog({
                            width: "auto",
                            resizable: false,
                            modal: false
                        });
                        return;
                    }
                    else if((start.day() < currentDate.day()) &&
                            (start.week() == currentDate.week()))
                    {
                        $("#error").dialog({
                            width: "auto",
                            resizable: false,
                            modal: false
                        });
                        return;
                    }
                    else if((start.hour() < currentDate.hour() + 1) &&
                            (start.day() == currentDate.day()) &&
                            (start.week() == currentDate.week()))
                    {
                        $("#error").dialog({
                            width: "auto",
                            resizable: false,
                            modal: false
                        });
                        return;
                    }
                    
                    end.minute(0);
                    end.hour(start.hour() + 1);
                    end.day(start.day());
                    var newid = 0;
                    if(events.length > 0)
                    {
                        newid = events[events.length-1].id + 1;
                    }
                    currentEvent = {
                        id: newid,
                        title: 'Ny konsultation',
                        start: start,
                        end: end,
                        allDay: false,
                        editable: false
                    };
                    
                    document.getElementById("dialog-form:hidden-date").value = currentEvent.start.format("MM/DD/YYYY");
                    document.getElementById("dialog-form:hidden-start").value = currentEvent.start.format("HH:mm");
                    document.getElementById("dialog-form:hidden-end").value = currentEvent.end.format("HH:mm");
                    
                    $('#calendar').fullCalendar('refetchEvents');
                    displayEvents();
                    $('#calendar').fullCalendar('renderEvent', currentEvent);
                },
                timeFormat: 'H(:mm)' // uppercase H for 24-hour clock
            });
            for(var i = 0; i < addAllEvents.length; i++)
            {
                addAllEvents[i]();
            }
            displayEvents();
        });
            //]]>
        </script>
        
        <c:forEach var="customer" items="#{customerManagedBean.customers}">
            <script>
                addAllEvents.push(function(){
                    insertEvent("#{customer.firstName}",
                                "#{customer.appointmentIdFk.timeReservationIdFk.reservationDate}",
                                "#{customer.appointmentIdFk.timeReservationIdFk.startTime}",
                                "#{customer.appointmentIdFk.timeReservationIdFk.stopTime}");
                });
            </script>
        </c:forEach>
    </h:body>
</html>

